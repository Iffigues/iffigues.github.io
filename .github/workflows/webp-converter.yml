name: Convert Images to WebP
on:
  push:
    branches: [ main, master ] # Se lance à chaque push sur la branche principale

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Récupère tout l'historique pour éviter les erreurs de push

      - name: Install WebP
        run: sudo apt-get install -y webp

      - name: Process Images
        run: |
          # Création du dossier old s'il n'existe pas
          TARGET_DIR="assets/data/eglise/img/noimh"
          mkdir -p "$TARGET_DIR/old"
          
          echo "Vérification du dossier : $TARGET_DIR"
          ls -R "$TARGET_DIR" # Affiche le contenu pour le debug dans les logs
          
          find "$TARGET_DIR" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" \) | while read img; do
            filename=$(basename "$img")
            basename="${filename%.*}"
            webp_path="$TARGET_DIR/${basename}.webp"
            
            echo "Processing: $filename"
            
            if [ ! -f "$webp_path" ]; then
              cwebp -q 80 "$img" -o "$webp_path"
            fi
            
            mv "$img" "$TARGET_DIR/old/"
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-convert images to WebP"